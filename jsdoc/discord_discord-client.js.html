<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: discord/discord-client.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: discord/discord-client.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check

import { config } from './../../config/config.js'
import discord, { Collection, Events } from 'discord.js'
import * as url from 'url'
import path from 'path'
import fileSystem from 'fs'
import * as databaseService from '../database/database-service.js'
import axios from 'axios'
import mongoose from 'mongoose'
import * as destinyService from './../destiny-service.js'

mongoose.set('strictQuery', false)
mongoose.connect(
    `mongodb+srv://${config.databaseUser}:${config.databasePassword}@${config.databaseCluster}.mongodb.net/${config.databaseName}`
)

/**
 * Connect to the Discord Client
 */
export async function setupDiscordClient() {
    const discordClient = new discord.Client({
        intents: [
            discord.GatewayIntentBits.Guilds,
            discord.GatewayIntentBits.GuildMessages,
            discord.GatewayIntentBits.MessageContent,
            discord.GatewayIntentBits.GuildMessageReactions
        ]
    })

    discordClient.commands = new Collection()
    discordClient.once(discord.Events.ClientReady, eventClient => {
        console.log(`Ready, logged in as ${eventClient.user.tag}`)
    })
    discordClient.login(config.token)

    setupSlashCommands(discordClient)
    replyToSlashCommands(discordClient)
}

/**
 * Initialiaze registered slash commands
 * @param {Object} discordClient Reference to Discord Client connection
 */
async function setupSlashCommands(discordClient) {
    const commandsPath = path.join(url.fileURLToPath(new URL('./', import.meta.url)), 'commands')
    const commandsFiles = fileSystem.readdirSync(commandsPath).filter(file => file.endsWith('.js'))

    for (const file of commandsFiles) {
        const filePath = path.join(commandsPath, file)
        const command = await import(`./commands/${file}`)

        if ('data' in command.default &amp;&amp; 'execute' in command.default) {
            discordClient.commands.set(command.default.data.name, command.default)
        } else {
            console.log(`The command at ${filePath} is missing "data" or "execute"`)
        }
    }
}

/**
 * Respond to any slash command and prompt user for profile information
 * @param {Object} discordClient Reference to Discord Client connection
 */
async function replyToSlashCommands(discordClient) {
    discordClient.on(Events.InteractionCreate, async interaction => {
        if (!interaction.isCommand()) return

        const command = interaction.client.commands.get(interaction.commandName)

        try {
            await interaction.reply('What is your Bungie Net username? (i.e. "Guardian#1234")')
            const filter = message => message.author.id === interaction.user.id
            const collector = interaction.channel.createMessageCollector({ filter, max: 1, time: 20000 })

            collector.on('collect', async message => {
                await handleIncommingMessage(message, interaction, command)
            })

            collector.on('end', async (collected) => {
                if (collected.size === 0) {
                    await interaction.followUp({
                        content: 'The interaction has timed out. After you have found your Bungie Net username, try again.'
                    })
                }
            })
        } catch (error) {
            console.log(error)
            await interaction.reply({ content: 'Something went wrong!' })
        }
    })
}

/**
 * Validate user's submitted profile information
 * @param {Object} message Message sent by user
 * @param {Object} interaction Reference to Discord Interaction
 * @param {Object} command Reference to current Command
 */
async function handleIncommingMessage(message, interaction, command) {
    if (await doesBungieUsernameExistInDestiny(message)) {
        await databaseService.doesUserExist(message.content) ?
            replyUserExists(interaction) :
            addUserToAlertBot(command, message.content, interaction)
    } else {
        interaction.followUp({ content: 'That is not a valid Bungie Net username!' })
    }
}

/**
 * Reply back to user that they're profile information exists in the database already
 * @param {Object} interaction Reference to Discord Interaction
 */
function replyUserExists(interaction) {
    interaction.followUp({ content: 'User already exists!' })
}

/**
 * Add user's profile information to database
 * @param {Object} command Reference to current Command
 * @param {string} username User's username
 * @param {Object} interaction Reference to Discord Interaction
 */
async function addUserToAlertBot(command, username, interaction) {
    await databaseService.addUser(username, interaction.user.id, interaction.channelId)
    command.execute(interaction)
}

/**
 * Validate the user's submitted username exists in Destiny 2
 * @param {Object} message Message sent by user
 * @returns {Promise&lt;boolean>} Response from Destiny 2 API for Bungie name
 */
async function doesBungieUsernameExistInDestiny(message) {
    const index = message.content.indexOf('#')
    const bungieUsername = message.content.substring(0, index)
    const bungieUsernameCode = message.content.substring(index + 1, message.content.length)
    const response = destinyService.getDestinyUsername(bungieUsername, bungieUsernameCode)

    return Object(response).length !== 0
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#addUserToAlertBot">addUserToAlertBot</a></li><li><a href="global.html#canManifestItemBeAdded">canManifestItemBeAdded</a></li><li><a href="global.html#compareModListWithUserInventory">compareModListWithUserInventory</a></li><li><a href="global.html#dailyReset">dailyReset</a></li><li><a href="global.html#discordRequest">discordRequest</a></li><li><a href="global.html#doesBungieUsernameExistInDestiny">doesBungieUsernameExistInDestiny</a></li><li><a href="global.html#doesUserExist">doesUserExist</a></li><li><a href="global.html#getAccessToken">getAccessToken</a></li><li><a href="global.html#getCollectibleFromManifest">getCollectibleFromManifest</a></li><li><a href="global.html#getCollectibleName">getCollectibleName</a></li><li><a href="global.html#getDestinyCharacterId">getDestinyCharacterId</a></li><li><a href="global.html#getDestinyCollectibleInfo">getDestinyCollectibleInfo</a></li><li><a href="global.html#getDestinyInventoryItemDefinition">getDestinyInventoryItemDefinition</a></li><li><a href="global.html#getDestinyMembershipInfo">getDestinyMembershipInfo</a></li><li><a href="global.html#getDestinyUsername">getDestinyUsername</a></li><li><a href="global.html#getDestinyVendorInfo">getDestinyVendorInfo</a></li><li><a href="global.html#getItemFromManifest">getItemFromManifest</a></li><li><a href="global.html#getItemName">getItemName</a></li><li><a href="global.html#getManifestFile">getManifestFile</a></li><li><a href="global.html#getProfileCollectibles">getProfileCollectibles</a></li><li><a href="global.html#getRefreshToken">getRefreshToken</a></li><li><a href="global.html#getVendorModInventory">getVendorModInventory</a></li><li><a href="global.html#handleAuthorizationCode">handleAuthorizationCode</a></li><li><a href="global.html#handleIncommingMessage">handleIncommingMessage</a></li><li><a href="global.html#readCollectiblesFromManifest">readCollectiblesFromManifest</a></li><li><a href="global.html#readFile">readFile</a></li><li><a href="global.html#readItemsFromManifest">readItemsFromManifest</a></li><li><a href="global.html#registerCommands">registerCommands</a></li><li><a href="global.html#replyToSlashCommands">replyToSlashCommands</a></li><li><a href="global.html#replyUserExists">replyUserExists</a></li><li><a href="global.html#sendMessage">sendMessage</a></li><li><a href="global.html#setupDiscordClient">setupDiscordClient</a></li><li><a href="global.html#setupSlashCommands">setupSlashCommands</a></li><li><a href="global.html#shareEmptyModsList">shareEmptyModsList</a></li><li><a href="global.html#shareUnownedModsList">shareUnownedModsList</a></li><li><a href="global.html#startServer">startServer</a></li><li><a href="global.html#updateRefreshToken">updateRefreshToken</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#writeFile">writeFile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Jun 13 2023 20:28:17 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
