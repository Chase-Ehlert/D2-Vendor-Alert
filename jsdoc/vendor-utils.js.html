<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: vendor-utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: vendor-utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check
import 'dotenv/config'
import axios from 'axios'
import { getCollectibleFromManifest, getItemFromManifest, getAggregatedManifestFile } from './manifest-utils.js'
import { updateRefreshToken } from './token-utils.js'

export async function getVendorModInventory(vendorId, user) {
  const oauthToken = await updateRefreshToken(user.refresh_token)
  const response = await axios.get(
    `https://www.bungie.net/Platform/Destiny2/3/Profile/${user.destiny_id}/Character/${user.destiny_character_id}/Vendors/`, {
    params: {
      components: 402
    },
    headers: {
      Authorization: `Bearer ${oauthToken}`,
      'x-api-key': `${process.env.VENDOR_ALERT_API_KEY}`
    }
  })

  let vendorInventory

  for (let key in response.data.Response.sales.data) {
    if (key === vendorId) {
      vendorInventory = response.data.Response.sales.data[key].saleItems
    }
  }

  return await getItemFromManifest(19, vendorInventory)
}

export async function getProfileCollectibles(user) {
  const profileResponse = await axios.get(`https://www.bungie.net/Platform/Destiny2/3/Profile/${user.destiny_id}/`, {
    params: {
      'components': 800
    },
    headers: {
      'x-api-key': `${process.env.VENDOR_ALERT_API_KEY}`
    }
  })

  /**
   * Banshee mod list
   * @type {Array&lt;string>}
   */
  const bansheeMods = await getVendorModInventory('672118013', user)
  console.log(`Banshee has these mods for sale: ${bansheeMods}`)

  const adaMods = await getVendorModInventory('350061650', user)
  console.log(`Ada has these mods for sale: ${adaMods}`)

  const collectibleList = []

  bansheeMods.concat(adaMods).forEach(key => {
    if (profileResponse.data.Response.profileCollectibles.data.collectibles[key].state === 65) {
      collectibleList.push(key)
    }
  })

  return await getCollectibleFromManifest(19, collectibleList)
}

export async function getXurInventory() {
  const response = await axios.get('https://www.bungie.net/Platform/Destiny2/Vendors/', {
    params: {
      components: 402
    },
    headers: {
      'X-API-Key': `${process.env.DESTINY_API_KEY}`
    }
  })
  const inventoryNameList = await getItemFromManifest(
    3,
    Object.values(Object.values(response.Response.sales.data)[0].saleItems)
  )
  return inventoryNameList
}

async function xur() {
  let xurInventoryMessage = "Xur is selling:\r\n"
  const xurItems = await getXurInventory()
  xurItems.forEach(item => {
    xurInventoryMessage = xurInventoryMessage + item + "\r\n"
  })
  return xurInventoryMessage
}

async function aggregateFile() {
  return await getAggregatedManifestFile()
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu May 18 2023 21:21:20 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
